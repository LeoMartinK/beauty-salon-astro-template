---
// src/pages/links.astro
import { siteData } from '../data/siteData';
import Layout from '../layouts/Layout.astro';

const { catalogs, info, social } = siteData;
const shareUrl = 'https://bit.ly/yanethcats';

// Definimos una interfaz simple para los items de la lista
interface CatalogLinkItem {
  label: string;
  slug?: string;
}

// --- 1. FUNCIÓN SLUGIFY ---
const slugify = (...args: (string | number | undefined)[]) => {
  return args
    .filter((arg) => arg !== undefined)
    .join(' ')
    .toLowerCase()
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g, '')
    .replace(/[^a-z0-9]+/g, '-')
    .replace(/^-+|-+$/g, '');
};

// --- 2. MAPAS DE ESTILO ---
const brandHeaderMap: Record<string, string> = {
  Natura: 'bg-orange-50',
  Avon: 'bg-red-50',
  Arbell: 'bg-green-50',
  Wineem: 'bg-indigo-50',
};

const brandBorderMap: Record<string, string> = {
  Natura: 'hover:border-orange-400/80',
  Avon: 'hover:border-red-500/80',
  Arbell: 'hover:border-green-500/80',
  Wineem: 'hover:border-indigo-400/80',
};

const brandShadowMap: Record<string, string> = {
  Natura: 'hover:shadow-[0_10px_30px_-10px_rgba(251,146,60,0.8)]',
  Avon: 'hover:shadow-[0_10px_30px_-10px_rgba(239,68,68,0.8)]',
  Arbell: 'hover:shadow-[0_10px_30px_-10px_rgba(34,197,94,0.8)]',
  Wineem: 'hover:shadow-[0_10px_30px_-10px_rgba(99,102,241,0.8)]',
};

const brandBadgeMap: Record<string, string> = {
  Natura: 'bg-orange-100 text-orange-800 border-orange-200',
  Avon: 'bg-red-100 text-red-800 border-red-200',
  Arbell: 'bg-green-100 text-green-800 border-green-200',
  Wineem: 'bg-indigo-100 text-indigo-800 border-indigo-200',
};
---

<Layout title="Catálogos Virtuales | Beauty Salon">
  <main class="flex min-h-screen justify-center bg-pastel-cream p-4 md:p-8 lg:p-12">
    <div class="grid w-full max-w-7xl grid-cols-1 items-start gap-8 lg:grid-cols-12 lg:gap-12">
      {/* --- SIDEBAR IZQUIERDO --- */}
      <aside
        class="z-10 flex flex-col items-center rounded-3xl border border-white/50 bg-white/60 text-center shadow-sm backdrop-blur-sm lg:sticky lg:top-8 lg:col-span-4 lg:items-start lg:bg-white lg:p-8 lg:text-left"
      >
        {/* FOTO */}
        <div class="group relative mb-6 h-32 w-32 cursor-default lg:h-48 lg:w-48">
          <div
            class="absolute inset-0 rounded-full bg-gradient-to-tr from-pink-300 to-amber-200 opacity-40 blur transition-opacity duration-500 group-hover:opacity-60"
          >
          </div>
          <img
            src="/web-app-manifest-512x512.png"
            alt="Beauty Salon Perfil"
            class="relative h-full w-full transform rounded-full border-[6px] border-white object-cover shadow-xl transition-transform duration-500 group-hover:scale-105"
          />
        </div>

        {/* INFO */}
        <h1 class="mb-2 font-serif text-3xl font-bold tracking-tight text-glam-navy lg:text-4xl">
          {info.author}
        </h1>
        <p
          class="mb-4 inline-block rounded-full border border-pink-100 bg-pink-50 px-3 py-1 text-xs font-bold uppercase tracking-widest text-pink-600"
        >
          Beauty Advisor
        </p>
        <p
          class="mx-auto mb-8 max-w-xs text-sm leading-relaxed text-gray-600 lg:max-w-none lg:text-base"
        >
          Explorá los últimos lanzamientos. Hacé tu pedido por WhatsApp directamente desde los
          catálogos.
        </p>

        {/* REDES SOCIALES */}
        <div class="mb-4 flex w-full justify-center gap-4 lg:justify-start">
          <a
            href={social.instagram}
            target="_blank"
            class="group flex flex-1 items-center justify-center gap-2 rounded-xl border border-gray-200 bg-white py-3 text-sm font-medium text-gray-600 shadow-sm transition-all hover:border-transparent hover:bg-gradient-to-r hover:from-purple-500 hover:to-pink-500 hover:text-white hover:shadow-md"
            ><svg
              xmlns="http://www.w3.org/2000/svg"
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              ><rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect><path
                d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path><line
                x1="17.5"
                y1="6.5"
                x2="17.51"
                y2="6.5"></line></svg
            ><span>Instagram</span></a
          >
          <a
            href={info.whatsappLink}
            target="_blank"
            class="flex flex-1 items-center justify-center gap-2 rounded-xl bg-glam-navy py-3 text-sm font-medium text-white shadow-md transition-all hover:bg-green-600 hover:shadow-lg"
            ><svg
              xmlns="http://www.w3.org/2000/svg"
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              ><path
                d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"
              ></path></svg
            ><span>WhatsApp</span></a
          >
        </div>

        {/* BOTÓN COMPARTIR */}
        <button
          id="share-btn"
          data-url={shareUrl}
          class="flex w-full transform items-center justify-center gap-2 rounded-xl bg-gradient-to-r from-pink-500 to-rose-500 py-3 text-sm font-bold tracking-wide text-white shadow-md transition-all hover:from-pink-600 hover:to-rose-600 hover:shadow-lg active:scale-95"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="18"
            height="18"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            ><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle
              cx="18"
              cy="19"
              r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line
              x1="15.41"
              y1="6.51"
              x2="8.59"
              y2="10.49"></line></svg
          >
          <span id="share-text">Compartir Catálogos</span>
        </button>
      </aside>

      {/* --- GRILLA DE CATÁLOGOS --- */}
      <section class="w-full pb-12 lg:col-span-8">
        {
          (!catalogs || catalogs.length === 0) && (
            <div class="rounded-2xl border border-pink-100 bg-white p-10 text-center shadow-sm">
              <p class="text-gray-500">No hay catálogos activos en este momento.</p>
            </div>
          )
        }

        <div class="grid grid-cols-1 gap-6 md:grid-cols-2 lg:gap-8">
          {
            catalogs &&
              catalogs.map((catalog) => {
                const isMulti = catalog.campaigns && catalog.campaigns.length > 1;
                const primaryCampaign = catalog.campaigns[0];
                const headerBg = brandHeaderMap[catalog.brand] || 'bg-gray-50';
                const hoverBorder = brandBorderMap[catalog.brand] || 'hover:border-gray-300';
                const hoverShadow = brandShadowMap[catalog.brand] || 'hover:shadow-xl';
                const badgeStyle = brandBadgeMap[catalog.brand] || 'bg-gray-100 text-gray-800';

                const getMaskedLink = (campPeriodValue: string, item: CatalogLinkItem) => {
                  if (item.slug) return `/r/${item.slug}`;
                  let parts = [catalog.brand, catalog.periodType, campPeriodValue];
                  if (
                    item.label &&
                    !item.label.includes('Ver Revista') &&
                    !item.label.includes('Catálogo')
                  ) {
                    parts.push(item.label);
                  }
                  return `/r/${slugify(...parts)}`;
                };

                return (
                  <div
                    class={`group relative overflow-hidden rounded-2xl border-2 border-transparent bg-white shadow-sm ${hoverBorder} ${hoverShadow} flex h-full flex-col transition-all duration-300 ease-out hover:-translate-y-1.5`}
                  >
                    {/* HEADER */}
                    <div
                      class={`flex items-center justify-between px-6 py-5 ${headerBg} border-b border-gray-100/50`}
                    >
                      <div class="relative z-10 flex items-center gap-4">
                        <div
                          class={`flex h-16 w-16 items-center justify-center overflow-hidden rounded-2xl p-2 shadow-sm transition-transform duration-300 group-hover:scale-105 ${catalog.logoBg || 'border border-gray-100 bg-white'}`}
                        >
                          <img
                            src={catalog.icon}
                            alt={catalog.brand}
                            class="h-full w-full object-contain"
                          />
                        </div>
                        <div>
                          <h3 class="text-xl font-bold leading-none text-gray-900">
                            {catalog.brand}
                          </h3>
                          {!isMulti && primaryCampaign && (
                            <span
                              class={`mt-1.5 inline-block rounded-md border px-2 py-0.5 text-[11px] font-bold uppercase tracking-wide ${badgeStyle}`}
                            >
                              {catalog.periodType} {primaryCampaign.periodValue}
                            </span>
                          )}
                        </div>
                      </div>
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="pointer-events-none absolute -right-6 -top-6 h-28 w-28 rotate-12 transform text-gray-900/5 transition-transform duration-500 group-hover:rotate-6"
                        fill="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path d="M4 19h10.5a5.5 5.5 0 0 0 0-11H5a3 3 0 0 1 0-6h14a2 2 0 0 1 2 2h2a4 4 0 0 0-4-4H5a5 5 0 0 0 0 10h9.5a3.5 3.5 0 0 1 0 7H4a2 2 0 0 1-2-2h-2a4 4 0 0 0 4 4z" />
                      </svg>
                    </div>

                    {/* BODY */}
                    <div class="flex flex-grow flex-col justify-center p-6">
                      {isMulti ? (
                        <div class="space-y-5">
                          {catalog.campaigns.map((camp) => (
                            <div class="relative border-l-2 border-gray-100 pl-4 transition-colors group-hover:border-gray-300">
                              <div class="mb-2 flex items-baseline justify-between">
                                <span
                                  class={`rounded border px-2 py-0.5 text-[10px] font-bold uppercase tracking-wider ${badgeStyle}`}
                                >
                                  {catalog.periodType} {camp.periodValue}
                                </span>
                                <span class="text-[11px] font-medium text-gray-700">
                                  {camp.vigencia}
                                </span>
                              </div>
                              <div class="mt-2 space-y-2">
                                {camp.items.map((link) => {
                                  const finalLink = getMaskedLink(camp.periodValue, link);
                                  return (
                                    <a
                                      href={finalLink}
                                      target="_blank"
                                      class="catalog-click-tracker block w-full text-left"
                                      data-slug={finalLink.replace('/r/', '')}
                                      data-brand={catalog.brand}
                                      data-period={camp.periodValue}
                                      data-label={link.label}
                                    >
                                      <div class="group/btn flex items-center justify-between rounded-xl border border-gray-200 bg-white px-4 py-3 text-gray-700 shadow-sm transition-all duration-200 hover:border-glam-navy hover:bg-glam-navy hover:text-white hover:shadow-md">
                                        <span class="text-sm font-semibold">{link.label}</span>
                                        <svg
                                          xmlns="http://www.w3.org/2000/svg"
                                          class="h-4 w-4 -translate-x-1 opacity-40 transition-all group-hover/btn:translate-x-0 group-hover/btn:opacity-100"
                                          fill="none"
                                          viewBox="0 0 24 24"
                                          stroke="currentColor"
                                        >
                                          <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"
                                          />
                                        </svg>
                                      </div>
                                    </a>
                                  );
                                })}
                              </div>
                            </div>
                          ))}
                        </div>
                      ) : (
                        <div class="space-y-3">
                          {primaryCampaign &&
                            primaryCampaign.items.map((link) => {
                              const finalLink = getMaskedLink(primaryCampaign.periodValue, link);
                              return (
                                <a
                                  href={finalLink}
                                  target="_blank"
                                  class="group/btn catalog-click-tracker flex w-full items-center gap-4 rounded-xl border border-gray-200 bg-gray-50 px-5 py-4 text-gray-700 shadow-sm transition-all duration-300 hover:border-transparent hover:bg-glam-navy hover:text-white hover:shadow-lg"
                                  data-slug={finalLink.replace('/r/', '')}
                                  data-brand={catalog.brand}
                                  data-period={primaryCampaign.periodValue}
                                  data-label={link.label}
                                >
                                  <div class="rounded-full bg-white p-2 text-glam-navy shadow-sm transition-colors group-hover/btn:bg-white/20 group-hover/btn:text-white">
                                    <svg
                                      xmlns="http://www.w3.org/2000/svg"
                                      class="h-5 w-5"
                                      fill="none"
                                      viewBox="0 0 24 24"
                                      stroke="currentColor"
                                    >
                                      <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                                      />
                                      <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"
                                      />
                                    </svg>
                                  </div>
                                  <span class="flex-grow text-sm font-bold">{link.label}</span>
                                  <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    class="h-5 w-5 opacity-40 group-hover/btn:opacity-100"
                                    fill="none"
                                    viewBox="0 0 24 24"
                                    stroke="currentColor"
                                  >
                                    <path
                                      stroke-linecap="round"
                                      stroke-linejoin="round"
                                      stroke-width="2"
                                      d="M14 5l7 7m0 0l-7 7m7-7H3"
                                    />
                                  </svg>
                                </a>
                              );
                            })}
                        </div>
                      )}
                    </div>
                  </div>
                );
              })
          }
        </div>
      </section>
    </div>
  </main>

  {/* SCRIPT UNIFICADO Y BLINDADO PARA CLIENT ROUTER */}
  <script is:inline>
    // Usamos 'astro:page-load' para que funcione al navegar
    document.addEventListener('astro:page-load', () => {
      // 1. LÓGICA DEL BOTÓN COMPARTIR
      const shareBtn = document.getElementById('share-btn');
      const shareText = document.getElementById('share-text');

      if (shareBtn) {
        shareBtn.addEventListener('click', async () => {
          const url = shareBtn.getAttribute('data-url');
          const title = 'Catálogos Beauty Salon';
          const textClean =
            '¡Hola! Te comparto los catálogos interactivos de Beauty Salon. Mirá lo nuevo de Natura, Avon y más acá:';
          const textFull = `${textClean} ${url}`;
          const shareData = { title: title, text: textClean, url: url };

          let shareMethod = 'unknown';

          if (navigator.share) {
            shareMethod = 'native_share';
            try {
              await navigator.share(shareData);
            } catch (err) {
              console.log('Compartir cancelado o error', err);
            }
          } else {
            shareMethod = 'clipboard';
            try {
              await navigator.clipboard.writeText(textFull);
              const originalText = shareText.innerText;
              shareText.innerText = '¡Copiado!';
              setTimeout(() => {
                shareText.innerText = originalText;
              }, 2500);
            } catch (err) {
              console.error('No se pudo copiar', err);
            }
          }

          // Enviar evento GA4
          if (typeof gtag !== 'undefined') {
            gtag('event', 'share', {
              method: shareMethod,
              content_type: 'catalog_list',
              item_id: 'links_page',
            });
          }
        });
      }

      // 2. LÓGICA DE RASTREO DE CLICS (GA4)
      const catalogLinks = document.querySelectorAll('.catalog-click-tracker');

      catalogLinks.forEach((link) => {
        link.addEventListener('click', () => {
          const slug = link.getAttribute('data-slug');
          const brand = link.getAttribute('data-brand');
          const period = link.getAttribute('data-period');
          const label = link.getAttribute('data-label');

          if (typeof gtag !== 'undefined') {
            gtag('event', 'select_content', {
              content_type: 'catalogo',
              item_id: slug,
              brand_name: brand,
              period: period,
              item_name: label,
            });
          }
        });
      });
    });
  </script>
</Layout>
